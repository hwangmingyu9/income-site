<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>수입 기록 전용 사이트 🍀</title>

  <!-- 엑셀 저장용 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase 초기화 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_JssdYuI3Lq8CUJibU2ex9cPRTlJWFSw",
      authDomain: "income-site-89fcf.firebaseapp.com",
      projectId: "income-site-89fcf",
      storageBucket: "income-site-89fcf.firebasestorage.app",
      messagingSenderId: "645854803885",
      appId: "1:645854803885:web:1771b066b5b3f9e12d1324"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    const eatsCol = collection(db, "eats");
    const incomeCol = collection(db, "income");
  </script>

  <style>
    body { margin:0; font-family:Pretendard,sans-serif; background:#fdfdfd; color:#333; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header { width:100%; text-align:center; font-size:22px; font-weight:700; color:#00b894; padding:20px 0; border-bottom:1px solid #eee; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.05); cursor:pointer; }
    .page { display:none; width:92%; max-width:450px; margin-top:30px; text-align:center; }
    .card { width:100%; background:#fff; border-radius:14px; box-shadow:0 4px 8px rgba(0,0,0,0.08); text-align:center; padding:18px 0; font-weight:600; margin-bottom:15px; transition:all 0.2s ease; }
    .card:hover { transform:translateY(-3px); }
    .card.green { background:#00b894; color:#fff; }
    .card.white { background:#fff; color:#00b894; border:1px solid #00b894; }
    .card.gray { background:#f5f5f5; color:#333; }
    footer { width:100%; text-align:center; font-weight:600; font-size:16px; color:#00b894; padding:15px 0; border-top:1px solid #eee; background:#fafafa; }
    .back-btn { background:none; color:#00b894; border:1px solid #00b894; padding:8px 14px; border-radius:8px; font-weight:600; margin-bottom:20px; cursor:pointer; }
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:20px; }
    .day { border:1px solid #eee; border-radius:10px; min-height:70px; padding:6px; font-size:12px; text-align:center; background:#fff; transition:0.15s; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .day:hover { border-color:#00b894; }
    .day.selected { border:2px solid #00b894; background:#e9fff7; }
    .day .date { font-weight:600; font-size:13px; margin-bottom:3px; }
    .income { font-size:12px; color:#00b894; font-weight:600; white-space:pre-line; line-height:1.4em; }
    .added { color:#ff0000; }
    input { width:92%; max-width:380px; padding:11px; border:1px solid #ccc; border-radius:12px; margin-bottom:10px; font-size:15px; text-align:center; background:#fff; transition:0.2s; }
    input:focus { outline:none; border:1px solid #00b894; box-shadow:0 0 4px rgba(0,184,148,0.3); }
    .history { margin-top:25px; background:#f9f9f9; border:1px solid #eee; border-radius:12px;padding:10px; max-height:180px; overflow-y:auto; }
    .history h3 { margin:0 0 10px 0; color:#00b894; font-size:15px; }
    .history-item { font-size:13px; margin-bottom:8px; line-height:1.4em; border-bottom:1px dashed #ddd; padding-bottom:5px; }
  </style>
</head>
<body>

  <header onclick="showPage('page-home')">수입 기록 전용 사이트 🍀</header>

  <!-- 홈 화면 -->
  <div class="page" id="page-home" style="display:block;">
    <img src="cloud.png" style="width:230px;margin-bottom:20px;">
    <div class="card green" onclick="showPage('page-eats')">쿠팡이츠 / 배민커넥트</div>
    <div class="card white" onclick="showPage('page-register')">새로운 수익 등록</div>
    <div class="card gray" onclick="showPage('page-excel')">월별 엑셀 다운로드</div>
  </div>

  <!-- 쿠팡/배민 등록 화면 -->
  <div class="page" id="page-eats">
    <button class="back-btn" onclick="showPage('page-home')">← 돌아가기</button>
    <h2>📊 쿠팡이츠 / 배민커넥트 수익</h2>
    <input id="eats" type="number" placeholder="쿠팡이츠 금액 (원)">
    <input id="baemin" type="number" placeholder="배민커넥트 금액 (원)">
    <button class="card green" id="saveEats">등록</button>
    <button class="card white" id="deleteEats">삭제</button>
    <div class="calendar" id="eats-calendar"></div>
    <div class="history" id="eats-history"><h3>📜 히스토리</h3><div id="eatsHistoryList"></div></div>
  </div>

  <!-- 새로운 수익 등록 화면 -->
  <div class="page" id="page-register">
    <button class="back-btn" onclick="showPage('page-home')">← 돌아가기</button>
    <h2 style="color:#00b894;">✨ 새로운 수익 등록</h2>
    <input id="incomeAmount" type="number" placeholder="금액 (원)">
    <input id="incomeReason" type="text" placeholder="원천 / 사유">
    <button class="card green" id="addIncome">등록</button>
    <button class="card white" id="deleteIncome">삭제</button>
    <div class="calendar" id="income-calendar"></div>
    <div class="history" id="income-history"><h3>📜 추가수익 히스토리</h3><div id="historyList"></div></div>
  </div>

  <!-- 엑셀 다운로드 화면 -->
  <div class="page" id="page-excel">
    <button class="back-btn" onclick="showPage('page-home')">← 돌아가기</button>
    <h2>📥 월별 엑셀 다운로드</h2>
    <button class="card gray" id="downloadExcel">엑셀 파일 다운로드</button>
  </div>

  <footer>이번 달 합계 : <span id="monthTotal">0</span>원 💰</footer>

  <!-- 스크립트: 데이터 처리 및 엑셀 저장 -->
  <script type="module">
    import { addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    function showPage(id){
      document.querySelectorAll(".page").forEach(p=>p.style.display="none");
      document.getElementById(id).style.display="block";
    }

    let eatsData = [], incomeData = [];

    function makeCalendar(id){
      const cal = document.getElementById(id);
      cal.innerHTML = "";
      for(let i=1;i<=31;i++){
        const d = document.createElement("div");
        d.classList.add("day");
        d.dataset.daynum = i;
        d.innerHTML = `<div class='date'>${i}</div>`;
        d.onclick = ()=> {
          document.querySelectorAll(`#${id} .day`).forEach(x=>x.classList.remove("selected"));
          d.classList.add("selected");
          window[id+'Sel'] = d;
        };
        cal.appendChild(d);
      }
    }
    makeCalendar("eats-calendar");
    makeCalendar("income-calendar");

    // 실시간 데이터 받아오기
    onSnapshot(eatsCol, snap => {
      eatsData = [];
      snap.forEach(d=>{ eatsData.push(d.data()); });
      renderEatsHistory();
      refreshCalendars();
    });
    onSnapshot(incomeCol, snap => {
      incomeData = [];
      snap.forEach(d=>{ incomeData.push(d.data()); });
      renderIncomeHistory();
      refreshCalendars();
    });

    function refreshCalendars(){
      const combined = {};
      eatsData.forEach(e=>{
        combined[e.day] = combined[e.day]||[];
        combined[e.day].push(e.total);
      });
      incomeData.forEach(i=>{
        combined[i.day] = combined[i.day]||[];
        combined[i.day].push(`[추가] ${i.amount}`);
      });

      ["eats-calendar","income-calendar"].forEach(id=>{
        document.querySelectorAll(`#${id} .day`).forEach(c=>{
          const day = c.dataset.daynum;
          if(combined[day]){
            let html = `<div class='date'>${day}</div><div class='income'>`;
            html += combined[day].map(v=>{
              if(typeof v === "string") return `<span class='added'>${v.replace(/\d+/,m=>Number(m).toLocaleString())}원</span>`;
              return `${v.toLocaleString()}원`;
            }).join("<br>");
            html += `</div>`;
            c.innerHTML = html;
          } else {
            c.innerHTML = `<div class='date'>${day}</div>`;
          }
        });
      });

      const total = Object.values(combined).flat().map(v=>parseInt(String(v).replace(/\D/g,"")||0)).reduce((a,b)=>a+b,0);
      document.getElementById("monthTotal").innerText = total.toLocaleString();
    }

    function renderEatsHistory(){
      const list = document.getElementById("eatsHistoryList");
      list.innerHTML = "";
      eatsData.forEach(e=>{
        const item = document.createElement("div");
        item.classList.add("history-item");
        item.innerHTML = `📅 ${e.day}일 | [쿠팡이츠] ${Number(e.eats).toLocaleString()}원 [배민커넥트] ${Number(e.baemin).toLocaleString()}원 [합계] ${Number(e.total).toLocaleString()}원`;
        list.appendChild(item);
      });
    }

    function renderIncomeHistory(){
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      incomeData.forEach(i=>{
        const item = document.createElement("div");
        item.classList.add("history-item");
        item.innerHTML = `📅 ${i.day}일 | ${i.amount.toLocaleString()}원 (${i.reason})`;
        list.appendChild(item);
      });
    }

    document.getElementById("saveEats").onclick = async ()=>{
      const target = window["eats-calendarSel"];
      if(!target){ alert("📅 날짜를 먼저 선택해주세요!"); return; }
      const day = target.dataset.daynum;
      const eats = Number(document.getElementById("eats").value||0);
      const baemin = Number(document.getElementById("baemin").value||0);
      if(eatsData.find(e=>e.day == day)){ alert("⚠️ 이미 등록된 날짜입니다!"); return; }
      await addDoc(eatsCol, { day, eats, baemin, total: eats+baemin });
      alert("✅ 정상적으로 등록되었습니다!");
    };

    document.getElementById("deleteEats").onclick = async ()=>{
      const target = window["eats-calendarSel"];
      if(!target){ alert("🗓️ 날짜를 선택해주세요!"); return; }
      const day = target.dataset.daynum;
      const docs = await getDocs(eatsCol);
      docs.forEach(async d=>{
        if(d.data().day == day) await deleteDoc(doc(db, "eats", d.id));
      });
      alert("🧹 삭제 완료되었습니다!");
    };

    document.getElementById("addIncome").onclick = async ()=>{
      const target = window["income-calendarSel"];
      if(!target){ alert("📅 날짜를 먼저 선택해주세요!"); return; }
      const day = target.dataset.daynum;
      const amount = Number(document.getElementById("incomeAmount").value||0);
      const reason = document.getElementById("incomeReason").value||"";
      await addDoc(incomeCol, { day, amount, reason });
      alert("✅ 수익이 추가되었습니다!");
    };

    document.getElementById("deleteIncome").onclick = async ()=>{
      const target = window["income-calendarSel"];
      if(!target){ alert("🗓️ 날짜를 선택해주세요!"); return; }
      const day = target.dataset.daynum;
      const docs = await getDocs(incomeCol);
      docs.forEach(async d=>{
        if(d.data().day == day) await deleteDoc(doc(db, "income", d.id));
      });
      alert("🧹 추가수익이 삭제되었습니다!");
    };

    // 엑셀 저장 기능은 추가 구현 가능…
  </script>

</body>
</html>
