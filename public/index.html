<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìˆ˜ì… ê¸°ë¡ ì „ìš© ì‚¬ì´íŠ¸ ğŸ€</title>

  <!-- ì—‘ì…€ ì €ì¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase ì´ˆê¸°í™” -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_JssdYuI3Lq8CUJibU2ex9cPRTlJWFSw",
      authDomain: "income-site-89fcf.firebaseapp.com",
      projectId: "income-site-89fcf",
      storageBucket: "income-site-89fcf.firebasestorage.app",
      messagingSenderId: "645854803885",
      appId: "1:645854803885:web:1771b066b5b3f9e12d1324"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    const eatsCol = collection(db, "eats");
    const incomeCol = collection(db, "income");
  </script>

  <style>
    body { margin:0; font-family:Pretendard,sans-serif; background:#fdfdfd; color:#333; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header { width:100%; text-align:center; font-size:22px; font-weight:700; color:#00b894; padding:20px 0; border-bottom:1px solid #eee; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.05); cursor:pointer; }
    .page { display:none; width:92%; max-width:450px; margin-top:30px; text-align:center; }
    .card { width:100%; background:#fff; border-radius:14px; box-shadow:0 4px 8px rgba(0,0,0,0.08); text-align:center; padding:18px 0; font-weight:600; margin-bottom:15px; transition:all 0.2s ease; }
    .card:hover { transform:translateY(-3px); }
    .card.green { background:#00b894; color:#fff; }
    .card.white { background:#fff; color:#00b894; border:1px solid #00b894; }
    .card.gray { background:#f5f5f5; color:#333; }
    footer { width:100%; text-align:center; font-weight:600; font-size:16px; color:#00b894; padding:15px 0; border-top:1px solid #eee; background:#fafafa; }
    .back-btn { background:none; color:#00b894; border:1px solid #00b894; padding:8px 14px; border-radius:8px; font-weight:600; margin-bottom:20px; cursor:pointer; }
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:20px; }
    .day { border:1px solid #eee; border-radius:10px; min-height:70px; padding:6px; font-size:12px; text-align:center; background:#fff; transition:0.15s; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .day:hover { border-color:#00b894; }
    .day.selected { border:2px solid #00b894; background:#e9fff7; }
    .day .date { font-weight:600; font-size:13px; margin-bottom:3px; }
    .income { font-size:12px; color:#00b894; font-weight:600; white-space:pre-line; line-height:1.4em; }
    .added { color:#ff0000; }
    input { width:92%; max-width:380px; padding:11px; border:1px solid #ccc; border-radius:12px; margin-bottom:10px; font-size:15px; text-align:center; background:#fff; transition:0.2s; }
    input:focus { outline:none; border:1px solid #00b894; box-shadow:0 0 4px rgba(0,184,148,0.3); }
    .history { margin-top:25px; background:#f9f9f9; border:1px solid #eee; border-radius:12px;padding:10px; max-height:180px; overflow-y:auto; }
    .history h3 { margin:0 0 10px 0; color:#00b894; font-size:15px; }
    .history-item { font-size:13px; margin-bottom:8px; line-height:1.4em; border-bottom:1px dashed #ddd; padding-bottom:5px; }
  </style>
</head>
<body>

  <header onclick="showPage('page-home')">ìˆ˜ì… ê¸°ë¡ ì „ìš© ì‚¬ì´íŠ¸ ğŸ€</header>

  <!-- í™ˆ í™”ë©´ -->
  <div class="page" id="page-home" style="display:block;">
    <img src="cloud.png" style="width:230px;margin-bottom:20px;">
    <div class="card green" onclick="showPage('page-eats')">ì¿ íŒ¡ì´ì¸  / ë°°ë¯¼ì»¤ë„¥íŠ¸</div>
    <div class="card white" onclick="showPage('page-register')">ìƒˆë¡œìš´ ìˆ˜ìµ ë“±ë¡</div>
    <div class="card gray" onclick="showPage('page-excel')">ì›”ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</div>
  </div>

  <!-- ì¿ íŒ¡/ë°°ë¯¼ ë“±ë¡ í™”ë©´ -->
  <div class="page" id="page-eats">
    <button class="back-btn" onclick="showPage('page-home')">â† ëŒì•„ê°€ê¸°</button>
    <h2>ğŸ“Š ì¿ íŒ¡ì´ì¸  / ë°°ë¯¼ì»¤ë„¥íŠ¸ ìˆ˜ìµ</h2>
    <input id="eats" type="number" placeholder="ì¿ íŒ¡ì´ì¸  ê¸ˆì•¡ (ì›)">
    <input id="baemin" type="number" placeholder="ë°°ë¯¼ì»¤ë„¥íŠ¸ ê¸ˆì•¡ (ì›)">
    <button class="card green" id="saveEats">ë“±ë¡</button>
    <button class="card white" id="deleteEats">ì‚­ì œ</button>
    <div class="calendar" id="eats-calendar"></div>
    <div class="history" id="eats-history"><h3>ğŸ“œ íˆìŠ¤í† ë¦¬</h3><div id="eatsHistoryList"></div></div>
  </div>

  <!-- ìƒˆë¡œìš´ ìˆ˜ìµ ë“±ë¡ í™”ë©´ -->
  <div class="page" id="page-register">
    <button class="back-btn" onclick="showPage('page-home')">â† ëŒì•„ê°€ê¸°</button>
    <h2 style="color:#00b894;">âœ¨ ìƒˆë¡œìš´ ìˆ˜ìµ ë“±ë¡</h2>
    <input id="incomeAmount" type="number" placeholder="ê¸ˆì•¡ (ì›)">
    <input id="incomeReason" type="text" placeholder="ì›ì²œ / ì‚¬ìœ ">
    <button class="card green" id="addIncome">ë“±ë¡</button>
    <button class="card white" id="deleteIncome">ì‚­ì œ</button>
    <div class="calendar" id="income-calendar"></div>
    <div class="history" id="income-history"><h3>ğŸ“œ ì¶”ê°€ìˆ˜ìµ íˆìŠ¤í† ë¦¬</h3><div id="historyList"></div></div>
  </div>

  <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í™”ë©´ -->
  <div class="page" id="page-excel">
    <button class="back-btn" onclick="showPage('page-home')">â† ëŒì•„ê°€ê¸°</button>
    <h2>ğŸ“¥ ì›”ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</h2>
    <button class="card gray" id="downloadExcel">ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <footer>ì´ë²ˆ ë‹¬ í•©ê³„ : <span id="monthTotal">0</span>ì› ğŸ’°</footer>

  <!-- ìŠ¤í¬ë¦½íŠ¸: ë°ì´í„° ì²˜ë¦¬ ë° ì—‘ì…€ ì €ì¥ -->
  <script type="module">
    import { addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    function showPage(id){
      document.querySelectorAll(".page").forEach(p=>p.style.display="none");
      document.getElementById(id).style.display="block";
    }

    let eatsData = [], incomeData = [];

    function makeCalendar(id){
      const cal = document.getElementById(id);
      cal.innerHTML = "";
      for(let i=1;i<=31;i++){
        const d = document.createElement("div");
        d.classList.add("day");
        d.dataset.daynum = i;
        d.innerHTML = `<div class='date'>${i}</div>`;
        d.onclick = ()=> {
          document.querySelectorAll(`#${id} .day`).forEach(x=>x.classList.remove("selected"));
          d.classList.add("selected");
          window[id+'Sel'] = d;
        };
        cal.appendChild(d);
      }
    }
    makeCalendar("eats-calendar");
    makeCalendar("income-calendar");

    // ì‹¤ì‹œê°„ ë°ì´í„° ë°›ì•„ì˜¤ê¸°
    onSnapshot(eatsCol, snap => {
      eatsData = [];
      snap.forEach(d=>{ eatsData.push(d.data()); });
      renderEatsHistory();
      refreshCalendars();
    });
    onSnapshot(incomeCol, snap => {
      incomeData = [];
      snap.forEach(d=>{ incomeData.push(d.data()); });
      renderIncomeHistory();
      refreshCalendars();
    });

    function refreshCalendars(){
      const combined = {};
      eatsData.forEach(e=>{
        combined[e.day] = combined[e.day]||[];
        combined[e.day].push(e.total);
      });
      incomeData.forEach(i=>{
        combined[i.day] = combined[i.day]||[];
        combined[i.day].push(`[ì¶”ê°€] ${i.amount}`);
      });

      ["eats-calendar","income-calendar"].forEach(id=>{
        document.querySelectorAll(`#${id} .day`).forEach(c=>{
          const day = c.dataset.daynum;
          if(combined[day]){
            let html = `<div class='date'>${day}</div><div class='income'>`;
            html += combined[day].map(v=>{
              if(typeof v === "string") return `<span class='added'>${v.replace(/\d+/,m=>Number(m).toLocaleString())}ì›</span>`;
              return `${v.toLocaleString()}ì›`;
            }).join("<br>");
            html += `</div>`;
            c.innerHTML = html;
          } else {
            c.innerHTML = `<div class='date'>${day}</div>`;
          }
        });
      });

      const total = Object.values(combined).flat().map(v=>parseInt(String(v).replace(/\D/g,"")||0)).reduce((a,b)=>a+b,0);
      document.getElementById("monthTotal").innerText = total.toLocaleString();
    }

    function renderEatsHistory(){
      const list = document.getElementById("eatsHistoryList");
      list.innerHTML = "";
      eatsData.forEach(e=>{
        const item = document.createElement("div");
        item.classList.add("history-item");
        item.innerHTML = `ğŸ“… ${e.day}ì¼ | [ì¿ íŒ¡ì´ì¸ ] ${Number(e.eats).toLocaleString()}ì› [ë°°ë¯¼ì»¤ë„¥íŠ¸] ${Number(e.baemin).toLocaleString()}ì› [í•©ê³„] ${Number(e.total).toLocaleString()}ì›`;
        list.appendChild(item);
      });
    }

    function renderIncomeHistory(){
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      incomeData.forEach(i=>{
        const item = document.createElement("div");
        item.classList.add("history-item");
        item.innerHTML = `ğŸ“… ${i.day}ì¼ | ${i.amount.toLocaleString()}ì› (${i.reason})`;
        list.appendChild(item);
      });
    }

    document.getElementById("saveEats").onclick = async ()=>{
      const target = window["eats-calendarSel"];
      if(!target){ alert("ğŸ“… ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
      const day = target.dataset.daynum;
      const eats = Number(document.getElementById("eats").value||0);
      const baemin = Number(document.getElementById("baemin").value||0);
      if(eatsData.find(e=>e.day == day)){ alert("âš ï¸ ì´ë¯¸ ë“±ë¡ëœ ë‚ ì§œì…ë‹ˆë‹¤!"); return; }
      await addDoc(eatsCol, { day, eats, baemin, total: eats+baemin });
      alert("âœ… ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    document.getElementById("deleteEats").onclick = async ()=>{
      const target = window["eats-calendarSel"];
      if(!target){ alert("ğŸ—“ï¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
      const day = target.dataset.daynum;
      const docs = await getDocs(eatsCol);
      docs.forEach(async d=>{
        if(d.data().day == day) await deleteDoc(doc(db, "eats", d.id));
      });
      alert("ğŸ§¹ ì‚­ì œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    document.getElementById("addIncome").onclick = async ()=>{
      const target = window["income-calendarSel"];
      if(!target){ alert("ğŸ“… ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
      const day = target.dataset.daynum;
      const amount = Number(document.getElementById("incomeAmount").value||0);
      const reason = document.getElementById("incomeReason").value||"";
      await addDoc(incomeCol, { day, amount, reason });
      alert("âœ… ìˆ˜ìµì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    document.getElementById("deleteIncome").onclick = async ()=>{
      const target = window["income-calendarSel"];
      if(!target){ alert("ğŸ—“ï¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
      const day = target.dataset.daynum;
      const docs = await getDocs(incomeCol);
      docs.forEach(async d=>{
        if(d.data().day == day) await deleteDoc(doc(db, "income", d.id));
      });
      alert("ğŸ§¹ ì¶”ê°€ìˆ˜ìµì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    // ì—‘ì…€ ì €ì¥ ê¸°ëŠ¥ì€ ì¶”ê°€ êµ¬í˜„ ê°€ëŠ¥â€¦
  </script>

</body>
</html>
